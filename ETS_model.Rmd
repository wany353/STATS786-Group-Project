---
title: "786group"
author: "Jinze Li"
date: "2024-05-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(fpp3)
library(ggplot2)
library(kableExtra)
```






```{r}
# 读取数据
data = read_csv("qgdp_training.csv")

# 选择第一列和第十七列
data = data %>% select(1, 17)

# 确保第一列是日期格式
data = data %>%
  mutate(Date = yearquarter(Date))

# 将数据转换为tsibble对象
ts_data = data %>%
  as_tsibble(index = Date)


ts_data <- ts_data %>%
  rename(Wholesale = `Wholesale Trade`)  # 列名调整

ts_data %>% 
  autoplot()
# 进行STL分解并画图
ts_data %>%
  model(stl = STL(Wholesale, robust = TRUE)) %>%
  components() %>%
  autoplot()

```


time plot show that整体上显示出一个上升趋势。可以看到数据有明显的周期性波动，反映了季节性变化。
For Trend：从图中可以看到，批发量总体呈现上升趋势。早期增长缓慢，中期（大约在2000年到2010年之间）有一段时间的平稳期，然后在最近几年又开始迅速上升。
For Seasonal：季节性图显示了周期性波动，早期的季节性波动幅度相对较小且稳定，但从中期开始，波动幅度明显增加。
For Remainder：残差部分看起来相对随机，说明去除趋势和季节性之后没有明显的结构或模式。

The time plot shows an overall upward trend. It can be observed that the data has obvious periodic fluctuations, reflecting seasonal variations.

For Trend:
From the plot, it can be seen that the wholesale volume shows an overall upward trend. In the early period, the growth was slow. During the middle period (approximately from 2000 to 2010), there was a period of stability, and then in recent years, it began to rise rapidly.

For Seasonal:
The seasonal plot shows periodic fluctuations. In the early period, the seasonal fluctuations were relatively small and stable, but starting from the middle period, the amplitude of the fluctuations increased significantly.

For Remainder:
The remainder part looks relatively random, indicating that after removing the trend and seasonal components, there are no obvious structures or patterns.


```{r}
# 手动拟合一些ETS模型
ets_manual <- ts_data %>%
  model(
    ets_mam = ETS(Wholesale ~ error("M") + trend("A") + season("M")),
    ets_aaa = ETS(Wholesale ~ error("A") + trend("A") + season("A")),
    ets_ana = ETS(Wholesale ~ error("A") + trend("N") + season("A"))
  )

# 打印模型结果
# report(ets_manual)
# 自动拟合ETS模型
ets_auto <- ts_data %>%
  model(ets = ETS(Wholesale))
# 打印模型结果
report(ets_auto)

# 比较模型
glance(ets_manual) %>%
  arrange(AICc)

glance(ets_auto)
```


By comparing the AICc values, we found that the smallest AICc belongs to both the manually fitted MAM ETS model and the automatically fitted model. Since they have the same AICc, we can select the best performing model, which is ets_mam.



```{r}
ets_manual %>% 
  select(ets_mam) %>% 
  gg_tsresiduals()



ets_manual %>% 
  select(ets_mam) %>% 
  augment() %>% 
  features(.innov,features = ljung_box,lag=12. ,dof=6)

```



```{r}
ETS=ets_manual %>% 
  select(ets_mam)

# 提取ETS模型的残差
ETS.resid <- ETS %>%
  augment() %>%
  select(.innov)

# Function to perform surrogate test for independence
surrogate.test = function(data, lag, N = 1000, test.stat = "ljung-box") {
  
  # data: a tsibble or numeric vector object
  # lag: number of lags in portmanteau test statistic
  # N: number of permutations to perform
  # test.stat: either "ljung-box" or "box-pierce"
  
  if (is_tsibble(data)) {
    if (length(measures(data)) != 1) {  
      stop("data must be a tsibble with one measurement variable")
    }
    # Extract time series 
    data = data %>% 
      pull(as.character(measures(data)[[1]])) 
  }

  n = length(data)

  Q.null = rep(NA, N)  # Open test statistic vectors
  
  if (test.stat == "ljung-box") {
    
    # Observed test statistic
    r.obs = acf(data, plot = FALSE)$acf[2:(lag + 1)]
    Q.obs = n * (n + 2) * sum(r.obs ^ 2 / (n - 1:lag))
    
    # Null distribution
    for (i in 1:N) {
      surrogate = sample(data, n)  # Permute data (kill autocorrelation, maintain amplitude)
      r = acf(surrogate, plot = FALSE)$acf[2:(lag + 1)]   # Estimate autocorrelation
      Q.null[i] = n * (n + 2) * sum(r ^ 2 / (n - 1:lag))  # Ljung-Box test statistic
    }
    
  }
  
  if (test.stat == "box-pierce") {
    
    # Observed test statistic
    r.obs = acf(data, plot = FALSE)$acf[2:(lag + 1)]
    Q.obs = n * sum(r.obs ^ 2)
    
    # Null distribution
    for (i in 1:N) {
      surrogate = sample(data, n)  # Permute data (kill autocorrelation, maintain amplitude)
      r = acf(surrogate, plot = FALSE)$acf[2:(lag + 1)]  # Estimate autocorrelation
      Q.null[i] = n * sum(r ^ 2)                         # Box-Pierce test statistic
    }
    
  }
  
  # Compute p-value
  p.value = mean(Q.null >= Q.obs)  # p-value

  # Output
  output = list(Q.null = Q.null,
                Q.obs = Q.obs,
                test.stat = test.stat,
                p.value = p.value)
  
  class(output) = "surrogate"
  
  return(output)
  
}

# 对提取的残差进行独立性检验

p_value <- surrogate.test(ETS.resid$.innov, 8, 1000)$p.value

# 输出p值
print(p_value)


```




```{r}
ETS=ets_manual %>% 
  select(ets_mam)

# 预测未来的值
forecasts <- ETS %>%
  forecast(h = "2 years") # 预测未来2年

# 绘制预测结果
autoplot(forecasts) +
  labs(title = "ETS Model Forecast",
       y = "Wholesale Trade",
       x = "Time")

# 绘制预测结果并添加原始数据
autoplot(forecasts) +
  autolayer(ts_data) + 
  labs(title = "ETS Model Forecast",
       y = "Wholesale Trade",
       x = "Time") +
  theme_minimal()

```